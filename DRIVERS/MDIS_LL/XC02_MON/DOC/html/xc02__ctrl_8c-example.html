<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - XC2 (DC1 carrier board) board controller driver - Example Documentation</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">XC2 (DC1 carrier board) board controller driver &nbsp; </h1>
	<h3>Example Documentation</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>xc02_ctrl.c</h1><div class="fragment"><pre><span class="comment">/****************************************************************************/</span>
 <span class="comment">/*</span>
<span class="comment"> *---------------------------------------------------------------------------</span>
<span class="comment"> * Copyright (c) 2009-2019, MEN Mikro Elektronik GmbH</span>
<span class="comment"> ****************************************************************************/</span>
<span class="comment">/*</span>
<span class="comment">* This program is free software: you can redistribute it and/or modify</span>
<span class="comment">* it under the terms of the GNU General Public License as published by</span>
<span class="comment">* the Free Software Foundation, either version 2 of the License, or</span>
<span class="comment">* (at your option) any later version.</span>
<span class="comment">*</span>
<span class="comment">* This program is distributed in the hope that it will be useful,</span>
<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment">* GNU General Public License for more details.</span>
<span class="comment">*</span>
<span class="comment">* You should have received a copy of the GNU General Public License</span>
<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">*/</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/men_typs.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_oss.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/usr_utl.h&gt;</span>
<span class="preprocessor">#include &lt;MEN/mdis_api.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="xc02__drv_8h.html">MEN/xc02_drv.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="xc02_8h.html">MEN/xc02.h</a>&gt;</span>

<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   GLOBALS                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> <a class="code" href="xc02__drv_8h.html#a52">MDIS_PATH</a> G_Path;
<span class="keyword">static</span> u_int32   G_SigCountSdEvt;    <span class="comment">/* count of shutdown event signals */</span>
<span class="keyword">static</span> u_int32   G_SigCountOthers;   <span class="comment">/* count of other signals */</span>


<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   PROTOTYPES                          |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a0"></a><a class="code" href="xc02__ctrl_8c.html#a7">usage</a>(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a1"></a><a class="code" href="xc02__ctrl_8c.html#a8">PrintMdisError</a>(<span class="keywordtype">char</span> *info);
<span class="keyword">static</span> <span class="keywordtype">void</span> <a name="a2"></a><a class="code" href="xc02__ctrl_8c.html#a9">PrintUosError</a>(<span class="keywordtype">char</span> *info);
<span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a3"></a><a class="code" href="xc02__ctrl_8c.html#a10">ShowIo</a>(<span class="keywordtype">void</span>);
<span class="keyword">static</span> <span class="keywordtype">void</span> __MAPILIB <a name="a4"></a><a class="code" href="xc02__ctrl_8c.html#a11">SigHandler</a>(u_int32 sigCode);



<span class="comment">/*--------------------------------------+</span>
<span class="comment">|   DEFINES                             |</span>
<span class="comment">+--------------------------------------*/</span>
<span class="preprocessor">#define NONE        -1</span>
<span class="preprocessor"></span><span class="preprocessor">#define IO_MAX_NBR  8</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define TEMP_INF    99999   </span><span class="comment">/* if no temperature was passed */</span>

<span class="comment">/* more compact error handling */</span>
<span class="preprocessor">#define CHK(expression,errst)       \</span>
<span class="preprocessor">    if((expression)&lt;0) {            \</span>
<span class="preprocessor">        PrintMdisError(errst);      \</span>
<span class="preprocessor">        goto abort;                 \</span>
<span class="preprocessor">    }</span>
<span class="preprocessor"></span>

<span class="comment">/********************************* usage ***********************************/</span>  
<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="xc02__ctrl_8c.html#a7">usage</a>(<span class="keywordtype">void</span>)
{
    printf( <span class="stringliteral">"xc02_ctrl [&lt;opts&gt;] &lt;device&gt; [&lt;opts&gt;]\n"</span>);
    printf(
  <span class="stringliteral">"Function: access MEN DCx display controller functions\n"</span>
  <span class="stringliteral">"Options:\n"</span>
  <span class="stringliteral">" device                  device name, e.g. xc02_1\n"</span>
  <span class="stringliteral">" -i                      get current settings and firmware build date\n"</span>
  <span class="stringliteral">" -t                      dump only carrier board temperature\n"</span>
  <span class="stringliteral">"-------------------------------- power-up settings -----------------------------------------\n"</span>
  <span class="stringliteral">" -w=&lt;min&gt;                set wake on time [min] (0=none)\n"</span>
  <span class="stringliteral">"-------------------------------- power-off settings ----------------------------------------\n"</span>
  <span class="stringliteral">" -d=&lt;mode&gt;               set shutdown delay:\n"</span>
  <span class="stringliteral">"                             mode       : 0 | 1 | 2 | 3 |...| 7 \n"</span>
  <span class="stringliteral">"                             time [min] : 0 | 1 | 2 | 4 |...| 64\n"</span>
  <span class="stringliteral">" -f=&lt;mode&gt;               set off delay:\n"</span>
  <span class="stringliteral">"                             mode       : 0 | 1 | 2 | 3 | 4 | 5\n"</span>
  <span class="stringliteral">"                             time [min] : 0 | 1 | 2 | 4 | 8 | 16\n"</span>
  <span class="stringliteral">" -s=&lt;magic&gt;              do software shutdown (with magic=0xA8, 168 dec.)\n"</span>
  <span class="stringliteral">"-------------------------------- binary inputs, temp settings ------------------------------\n"</span>
  <span class="stringliteral">" -H=&lt;limit&gt;              set temperature high limit                    [degree celsius]\n"</span>
  <span class="stringliteral">" -L=&lt;limit&gt;              set temperature low  limit                    [degree celsius]\n"</span>
  <span class="stringliteral">" -I                      continously read bin-IO/temp/volt/brightness\n"</span>
  <span class="stringliteral">" -k=&lt;KEY_IN control&gt;     control board startup behavior   -k=0:         start up on KEY_IN=1\n"</span>
  <span class="stringliteral">"                                                          -k=1: always start up when powered\n"</span>
  <span class="stringliteral">"-------------------------------- Display control -------------------------------------------\n"</span>
  <span class="stringliteral">" -o=&lt;0,1&gt;                select primary or secondary screen for brightness commands:\n"</span>
  <span class="stringliteral">" -b=&lt;bright&gt;             set brightness in 0,5 percent steps                   [0-200, dec.]\n"</span>
  <span class="stringliteral">" -a=&lt;bright&gt;             set initial brightness of display &lt;-o&gt;                [0-200, dec.]\n"</span>
  <span class="stringliteral">" -r=&lt;src&gt;                set brightness source                       [0:use &lt;-b&gt;, 1:sensor ]\n"</span>
  <span class="stringliteral">" -m=&lt;mult&gt;               set auto brightness multiplier                   [ x0.1,default:10]\n"</span>
  <span class="stringliteral">" -q=&lt;offs&gt;               set auto brightness offset                            [0-254, dec.]\n"</span>
  <span class="stringliteral">" -p                      SC21 only: power drawn from backlight/panel (12V rail)          [W]\n"</span>
  <span class="stringliteral">" -c=&lt;switch&gt;             switch displays off/on:                        -c=0 pri:OFF sec:OFF\n"</span>
  <span class="stringliteral">"                         (2nd Display optional)                         -c=1 pri: ON sec:OFF\n"</span>
  <span class="stringliteral">"                                                                        -c=2 pri:OFF sec: ON\n"</span>
  <span class="stringliteral">"                                                                        -c=3 pri: ON sec: ON\n\n"</span>
  <span class="stringliteral">" -z=&lt;init.state&gt;         initial panel state (!!! USE WITH CARE !!!) [values: see option -c]\n"</span>
  <span class="stringliteral">" -g=&lt;bright.direction&gt;   auto brightness behavior       [0:XC02/SC21 Std  1:inverse (DC2/6)]\n"</span>
        );
}

<span class="keyword">static</span> <span class="keywordtype">int</span> <a name="a5"></a><a class="code" href="xc02__ctrl_8c.html#a12">showInfo</a>(<span class="keywordtype">void</span>)
{

    int32   val, chan;
    <span class="keywordtype">float</span> mul=0.0;

    printf(<span class="stringliteral">"current settings:\n"</span>);

    <a name="a6"></a><a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a name="a7"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_WOT, &amp;val)),<span class="stringliteral">" XC02_WOT"</span> );
    printf(<span class="stringliteral">"- wake on time                : %dmin\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_WDOG_ERR, &amp;val)),<span class="stringliteral">" XC02_WDOG_ERR"</span> );
    printf(<span class="stringliteral">"- missing wdog triggers       : %d\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_DOWN_DELAY, &amp;val)),<span class="stringliteral">" XC02_DOWN_DELAY"</span>);
    printf(<span class="stringliteral">"- shutdown delay              : %d min\n"</span>,
           <a name="a8"></a><a class="code" href="group____XC02__DOWN__DELAY.html#a0">XC02C_DOWN_DELAY_MIN</a>( val ));

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_OFF_DELAY, &amp;val)),<span class="stringliteral">" XC02_OFF_DELAY"</span>);
    printf(<span class="stringliteral">"- off delay                   : %dmin\n"</span>,
           <a name="a9"></a><a class="code" href="group____XC02__OFF__DELAY.html#a0">XC02C_OFF_DELAY_MIN</a>( val ));

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_DOWN_EVT, &amp;val)),<span class="stringliteral">" XC02_DOWN_EVT"</span>);
    printf(<span class="stringliteral">"- shutdown event flag         : %d\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_IN, &amp;val)), <span class="stringliteral">" XC02_IN"</span>);
    printf(<span class="stringliteral">"- binary inputs               : 0x%x\n"</span>, val );

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_VOLTAGE, &amp;val)),<span class="stringliteral">" XC02_VOLTAGE"</span>);
    printf(<span class="stringliteral">"- Voltage                     : %d mV (raw 0x%x)\n"</span>,
           <a name="a10"></a><a class="code" href="xc02__drv_8h.html#a41">XC02_ADC2VOLT</a>(val), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BRIGHTNESS, &amp;val)),<span class="stringliteral">" XC02_BRIGHTNESS"</span>);
    printf(<span class="stringliteral">"- Brightness                  : %d% (raw 0x%x)\n"</span>,
           100 - (val &gt;&gt; 1), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_RAW_BRIGHTNESS, &amp;val)),<span class="stringliteral">" XC02_RAW_BRIGHTNESS"</span>);
    printf(<span class="stringliteral">"- Brightness Raw ADC          : %d \n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BR_SRC, &amp;val )), <span class="stringliteral">" XC02_BR_SRC"</span>);
    printf(<span class="stringliteral">"- brightness source           : %s\n"</span>, val ? <span class="stringliteral">"auto"</span> : <span class="stringliteral">"manual"</span>);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BR_OFFS, &amp;val)),<span class="stringliteral">" XC02_BR_OFFS"</span>);
    printf(<span class="stringliteral">"- Brightness offset           : 0x%02x\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BR_MULT, &amp;val)),<span class="stringliteral">" XC02_BR_MULT"</span>);
    mul=(<span class="keywordtype">float</span>)((<span class="keywordtype">float</span>)val/10.0);
    printf(<span class="stringliteral">"- Brightness multiplier       : %1.1f\n"</span>, mul<span class="comment">/*(float)(val/10)*/</span>);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_DISP_INITSTAT, &amp;val )), <span class="stringliteral">"XC02_DISP_INITSTAT"</span>);
    printf(<span class="stringliteral">"- initial displaystatus       : pri: %s sec: %s\n"</span>, (val&amp;0x1) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span>,  (val&amp;0x2) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span> );

    chan = 0;
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a name="a11"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, M_MK_CH_CURRENT, chan)), <span class="stringliteral">"M_MK_CH_CURRENT"</span>);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_INIT_BRIGHT, &amp;val )), <span class="stringliteral">"XC02_INIT_BRIGHT"</span>);
    printf(<span class="stringliteral">"- initial brightness 1        : %d % (raw 0x%x)\n"</span>,
           100 - (val &gt;&gt; 1), val);
    chan = 1;
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, M_MK_CH_CURRENT, chan)), <span class="stringliteral">"M_MK_CH_CURRENT"</span>);
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_INIT_BRIGHT, &amp;val )), <span class="stringliteral">"XC02_INIT_BRIGHT"</span>);
    printf(<span class="stringliteral">"- initial brightness 2(option): %d % (raw 0x%x)\n"</span>,
           100 - (val &gt;&gt; 1), val);

    <span class="comment">/* Temp &amp; limits */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP, &amp;val)),   <span class="stringliteral">" XC02_TEMP"</span>);
    printf(<span class="stringliteral">"- temperature                 : %d degree Celsius(raw 0x%x)\n"</span>,
           <a name="a12"></a><a class="code" href="xc02__drv_8h.html#a39">XC02_ADC2TEMP</a>(val), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP_HIGH, &amp;val)),<span class="stringliteral">" TEMP_HIGH"</span>);
    printf(<span class="stringliteral">"- Temp high limit             : %d degree Celsius\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP_LOW, &amp;val)),<span class="stringliteral">" TEMP_LOW"</span>);
    printf(<span class="stringliteral">"- Temp low limit              : %d degree Celsius\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_VOLTAGE, &amp;val)),<span class="stringliteral">" XC02_VOLTAGE"</span>);
    printf(<span class="stringliteral">"- Voltage                     : %d mV (raw 0x%x)\n"</span>,
           <a class="code" href="xc02__drv_8h.html#a41">XC02_ADC2VOLT</a>(val), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_VOLT_HIGH, &amp;val)),<span class="stringliteral">" VOLT_HIGH"</span>);
    printf(<span class="stringliteral">"- Volt high limit             : %d mV\n"</span>,
           <a class="code" href="xc02__drv_8h.html#a41">XC02_ADC2VOLT</a>(val));

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_VOLT_LOW, &amp;val)),<span class="stringliteral">" VOLT_LOW"</span>);
    printf(<span class="stringliteral">"- Volt low limit              : %d mV\n"</span>,
           <a class="code" href="xc02__drv_8h.html#a41">XC02_ADC2VOLT</a>(val));

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_KEY_IN_CTRL, &amp;val)),<span class="stringliteral">" XC02_KEY_IN_CTRL"</span>);
    printf(<span class="stringliteral">"- KEY_IN control:             : %d (%s)\n"</span>, val, val ? <span class="stringliteral">"always on"</span> : <span class="stringliteral">"KEY_IN"</span>);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, SC21_BL_CURRENT, &amp;val )), <span class="stringliteral">" SC21_BL_CURRENT"</span>);
    <span class="keywordflow">if</span> (val == 0xff) {
        printf(<span class="stringliteral">"- drawn power (12V rail)      : &lt;unknown&gt;\n"</span>, <a name="a13"></a><a class="code" href="xc02__drv_8h.html#a42">SC21_ADC2POWER</a>(val));
    } <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"- drawn power (12V rail)      : %d W\n"</span>, <a class="code" href="xc02__drv_8h.html#a42">SC21_ADC2POWER</a>(val));
    }

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_AUTO_BRIGHT_CTRL, &amp;val)),<span class="stringliteral">" XC02_AUTO_BRIGHT_CTRL"</span>);
    printf(<span class="stringliteral">"- auto brightness direction   : %d (%s)\n"</span>, val, val ? <span class="stringliteral">"DC2/6"</span> : <span class="stringliteral">"default"</span>);

    <span class="comment">/* PIC firmware built string */</span>
    printf(<span class="stringliteral">"firmware build string:\n"</span>);
    <span class="keywordflow">do</span> {
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>(( <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>( G_Path, XC02_TIMESTAMP, &amp;val)),<span class="stringliteral">" XC02_TIMESTAMP"</span> );
        <span class="keywordflow">if</span> (val == 0xff)
            <span class="keywordflow">break</span>;
        printf(<span class="stringliteral">"%c"</span>, val);
        UOS_Delay(8);
    } <span class="keywordflow">while</span> (val !=0xff);
    printf(<span class="stringliteral">"\n"</span>);

    <span class="keywordflow">return</span>(0);

abort:
    <span class="keywordflow">return</span>(1);

}

<span class="comment">/********************************* main ************************************/</span>
<span class="keywordtype">int</span> <a name="a14"></a><a class="code" href="xc02__ctrl_8c.html#a13">main</a>( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordtype">char</span>    *device,*str,*errstr,buf[255];
    int32   info, ioInfo;
    int32   wot, val;
    int32   sdDelay, offDelay, swSd, sdEvtPollTime, arg_broffs, arg_brmult;
    int32   arg_tempHi, arg_tempLo, tempHigh, arg_gettemp, arg_power;
    int32   arg_source, arg_swDisp, arg_screen, arg_keyctrl;
    int32   arg_brightdir, arg_initstate;
    int32   n, arg_bright, arg_inibright;
    <span class="keywordtype">float</span>   mul;

    <span class="comment">/*-------------------+</span>
<span class="comment">      | check arguments  |</span>
<span class="comment">      +-----------------*/</span>
    <span class="keywordflow">if</span>( (errstr = UTL_ILLIOPT(<span class="stringliteral">"ptiIw=n=a=d=f=s=e=o=q=m=H=L=b=a=c=r=k=z=g=?"</span>, buf)) )
    {   <span class="comment">/* check args */</span>
        printf(<span class="stringliteral">"*** %s\n"</span>, errstr);
        <span class="keywordflow">return</span>(1);
    }

    <span class="keywordflow">if</span>( UTL_TSTOPT(<span class="stringliteral">"?"</span>) ){                      <span class="comment">/* help requested ? */</span>
        <a class="code" href="xc02__ctrl_8c.html#a7">usage</a>();
        <span class="keywordflow">return</span>(1);
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">      |  get arguments    |</span>
<span class="comment">      +------------------*/</span>
    <span class="keywordflow">for</span> (device=NULL, n=1; n&lt;argc; n++)
        <span class="keywordflow">if</span>( *argv[n] != <span class="charliteral">'-'</span> ){
            device = argv[n];
            <span class="keywordflow">break</span>;
        }

    <span class="keywordflow">if</span>( !device || argc&lt;3 ) {
        <a class="code" href="xc02__ctrl_8c.html#a7">usage</a>();
        <span class="keywordflow">return</span>(1);
    }

    info          = (UTL_TSTOPT(<span class="stringliteral">"i"</span>) ? 1 : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    ioInfo        = (UTL_TSTOPT(<span class="stringliteral">"I"</span>) ? 1 : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_gettemp   = (UTL_TSTOPT(<span class="stringliteral">"t"</span>) ? 1 : 0);
    arg_power     = (UTL_TSTOPT(<span class="stringliteral">"p"</span>) ? 1 : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    wot           = ((str = UTL_TSTOPT(<span class="stringliteral">"w="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    sdDelay       = ((str = UTL_TSTOPT(<span class="stringliteral">"d="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    offDelay      = ((str = UTL_TSTOPT(<span class="stringliteral">"f="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    swSd          = ((str = UTL_TSTOPT(<span class="stringliteral">"s="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    sdEvtPollTime = ((str = UTL_TSTOPT(<span class="stringliteral">"e="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_tempHi    = ((str = UTL_TSTOPT(<span class="stringliteral">"H="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a>);
    arg_tempLo    = ((str = UTL_TSTOPT(<span class="stringliteral">"L="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a>);
    arg_bright    = ((str = UTL_TSTOPT(<span class="stringliteral">"b="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_source    = ((str = UTL_TSTOPT(<span class="stringliteral">"r="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_swDisp    = ((str = UTL_TSTOPT(<span class="stringliteral">"c="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_screen    = ((str = UTL_TSTOPT(<span class="stringliteral">"o="</span>)) ? atoi(str) : 0);
    arg_inibright = ((str = UTL_TSTOPT(<span class="stringliteral">"a="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    arg_broffs    = ((str = UTL_TSTOPT(<span class="stringliteral">"q="</span>)) ? atoi(str) : -1);
    arg_brmult    = ((str = UTL_TSTOPT(<span class="stringliteral">"m="</span>)) ? atoi(str) : -1);

    arg_keyctrl   = ((str = UTL_TSTOPT(<span class="stringliteral">"k="</span>)) ? atoi(str) : -1);
    arg_brightdir = ((str = UTL_TSTOPT(<span class="stringliteral">"g="</span>)) ? atoi(str) : -1);
    arg_initstate = ((str = UTL_TSTOPT(<span class="stringliteral">"z="</span>)) ? atoi(str) : -1);
    
    tempHigh      = ((str = UTL_TSTOPT(<span class="stringliteral">"T="</span>)) ? atoi(str) : <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>);
    (<span class="keywordtype">void</span>) tempHigh;

    <span class="comment">/* sanity check of passed args */</span>
    <span class="keywordflow">if</span> ( (arg_tempLo &lt; <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a>) &amp;&amp; (arg_tempHi &lt; <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a>)) {
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (arg_tempHi-arg_tempLo), <span class="stringliteral">"low temp above high temp"</span>);
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">      |  open path          |</span>
<span class="comment">      +--------------------*/</span>

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (G_Path = <a name="a15"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a4">M_open</a>(device)),<span class="stringliteral">"open"</span>);

    <span class="comment">/* current settings summary */</span>
    <span class="keywordflow">if</span>( info != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> )
        <a class="code" href="xc02__ctrl_8c.html#a12">showInfo</a>();

    <span class="comment">/* set wake on time ? */</span>
    <span class="keywordflow">if</span>( wot != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ) {
        printf(<span class="stringliteral">"- set wake on time to: %dmin\n"</span>, wot);
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_WOT, wot)),<span class="stringliteral">" XC02_WOT"</span>);
    }

    <span class="comment">/* set brightness ? */</span>
    <span class="keywordflow">if</span> ( arg_bright &gt;=0) {
        <span class="keywordflow">if</span> (arg_screen == 0) {
            printf(<span class="stringliteral">"- set brightness of Screen 0 to %d\n"</span>, arg_bright );
            <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path,XC02_BRIGHTNESS, arg_bright)),
                <span class="stringliteral">"setstat XC02_BRIGHTNESS"</span>);
        }
        <span class="keywordflow">if</span> (arg_screen == 1){
            printf(<span class="stringliteral">"- set brightness of Screen 1 to %d\n"</span>, arg_bright );
            <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path,XC02_BRIGHTNESS2, arg_bright)),
                <span class="stringliteral">"setstat XC02_BRIGHTNESS2"</span>);
        }
    }

    <span class="comment">/* set initial brightness ? */</span>
    <span class="keywordflow">if</span> ( arg_inibright &gt;=0 ) {
        <span class="comment">/* select the screen */</span>
        printf(<span class="stringliteral">"- set initial brightness of Screen %d to %d\n"</span>,
               arg_screen, arg_inibright );

        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, M_MK_CH_CURRENT, arg_screen)),
            <span class="stringliteral">"setstat M_MK_CH_CURRENT"</span>);

        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_INIT_BRIGHT, arg_inibright)),
            <span class="stringliteral">"setstat XC02_INIT_BRIGHT"</span>);
    }

    <span class="comment">/* set shutdown delay ? */</span>
    <span class="keywordflow">if</span>( sdDelay != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
        printf(<span class="stringliteral">"- set shutdown delay to: mode=%d (%dmin)\n"</span>,
               sdDelay, <a class="code" href="group____XC02__DOWN__DELAY.html#a0">XC02C_DOWN_DELAY_MIN</a>(sdDelay));
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_DOWN_DELAY, sdDelay)),
            <span class="stringliteral">"setstat XC02_DOWN_DELAY"</span>);
    }

    <span class="comment">/* set off delay ? */</span>
    <span class="keywordflow">if</span>( offDelay != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
        printf(<span class="stringliteral">"- set off delay to: mode=%d (%dmin)\n"</span>,
               offDelay, <a class="code" href="group____XC02__OFF__DELAY.html#a0">XC02C_OFF_DELAY_MIN</a>(offDelay));
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_OFF_DELAY, offDelay)),<span class="stringliteral">"XC02_OFF_DELAY"</span>);
    }

    <span class="comment">/* initiate a software shutdown ? */</span>
    <span class="keywordflow">if</span>( swSd != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
        printf(<span class="stringliteral">"- initiate a software shutdown\n"</span>);
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_SWOFF, swSd)),<span class="stringliteral">"XC02_SWOFF"</span>);
    }

    <span class="comment">/* get temperature ? */</span>
    <span class="keywordflow">if</span> (arg_gettemp) { <span class="comment">/* temp */</span>
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP, &amp;val)), <span class="stringliteral">" XC02_TEMP"</span>);
        printf(<span class="stringliteral">"XC2 Temp: %d degree celsius (raw 0x%x)\n"</span>,
               <a class="code" href="xc02__drv_8h.html#a39">XC02_ADC2TEMP</a>(val), val);
    }

    <span class="comment">/* set new temperature high limit */</span>
    <span class="keywordflow">if</span>( arg_tempHi != <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a> ){
        printf(<span class="stringliteral">"- set temperature high limit: %d\n"</span>, arg_tempHi);
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_TEMP_HIGH, arg_tempHi )),<span class="stringliteral">" XC02_TEMP_HIGH"</span>);
    }

    <span class="comment">/* set new temperature low limit */</span>
    <span class="keywordflow">if</span>( arg_tempLo != <a class="code" href="xc02__ctrl_8c.html#a2">TEMP_INF</a> ){
        printf(<span class="stringliteral">"- set temperature low limit: %d\n"</span>, arg_tempLo );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_TEMP_LOW, arg_tempLo )), <span class="stringliteral">"XC02_TEMP_LOW"</span>);
    }

    <span class="comment">/* select the brightness control source */</span>
    <span class="keywordflow">if</span> (arg_source&gt;=0) {
        printf(<span class="stringliteral">"- set brightness source to %s\n"</span>,
               arg_source ? <span class="stringliteral">"auto"</span> : <span class="stringliteral">"SMB cmd"</span> );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_BR_SRC, arg_source )), <span class="stringliteral">"XC02_BR_SRC"</span>);
    }

    <span class="comment">/* switch display(s) with bit0 and bit1 */</span>
    <span class="keywordflow">if</span> ( (arg_swDisp &gt;= 0) &amp;&amp; (arg_swDisp &lt;= 3 ) ) {
        printf(<span class="stringliteral">"- switch display1 %s, display2 %s (display2 only DC1R01)\n"</span>,
               (arg_swDisp &amp; 0x1) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span> ,
               (arg_swDisp &amp; 0x2) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span> );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_SW_DISP, arg_swDisp )),<span class="stringliteral">"XC02_SW_DISP"</span>);
    }

    arg_broffs    = ((str = UTL_TSTOPT(<span class="stringliteral">"q="</span>)) ? atoi(str) : -1);
    arg_brmult    = ((str = UTL_TSTOPT(<span class="stringliteral">"m="</span>)) ? atoi(str) : -1);

    <span class="comment">/* brightness offset passed */</span>
    <span class="keywordflow">if</span> ( arg_broffs &gt;= 0 ) {
        printf(<span class="stringliteral">"- set auto brightness offset = %d\n"</span>, arg_broffs );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_BR_OFFS, arg_broffs)), <span class="stringliteral">"XC02_BR_OFFS"</span>);
    }

    <span class="comment">/* multiplier passed */</span>
    <span class="keywordflow">if</span> ( arg_brmult &gt;= 0 ) {
        mul=(<span class="keywordtype">float</span>)((<span class="keywordtype">float</span>)arg_brmult/10.0);
        printf(<span class="stringliteral">"- set auto brightness multiplier = %1.1f\n"</span>, mul );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>( G_Path, XC02_BR_MULT, arg_brmult)), <span class="stringliteral">"XC02_BR_MULT"</span>);
    }

    <span class="comment">/* get drawn SC21 12V power */</span>
    <span class="keywordflow">if</span> (arg_power == 1) {
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, SC21_BL_CURRENT, &amp;val )), <span class="stringliteral">"SC21_BL_CURRENT"</span>);
        <span class="keywordflow">if</span> (val == 0xff) {
            printf(<span class="stringliteral">" *** SC21_BL_CURRENT returned 0xff (board no SC21?)\n"</span>);
        } <span class="keywordflow">else</span> {
            printf(<span class="stringliteral">" drawn power (12V rail) = %d W\n"</span>, <a class="code" href="xc02__drv_8h.html#a42">SC21_ADC2POWER</a>(val));
        }
    }

    <span class="comment">/* KEY_IN behavior */</span>
    <span class="keywordflow">if</span> ( (arg_keyctrl == 0) || (arg_keyctrl == 1) ) {
        printf(<span class="stringliteral">"- set KEY_IN behavior = %d\n"</span>, arg_keyctrl );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_KEY_IN_CTRL, arg_keyctrl)), <span class="stringliteral">"XC02_KEY_IN_CTRL"</span>);
    }

    <span class="comment">/* initial display state */</span>
    <span class="keywordflow">if</span> ( (arg_initstate &gt;=0) &amp;&amp; (arg_initstate &lt;= 3 )) {
        printf(<span class="stringliteral">"- set initial display state = %d ( pri: %s sec: %s)\n"</span>, 
               arg_initstate,
               ( arg_initstate &amp; 0x1 ) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span>,
               ( arg_initstate &amp; 0x2 ) ? <span class="stringliteral">"ON"</span> : <span class="stringliteral">"OFF"</span> );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_DISP_INITSTAT, arg_initstate)), <span class="stringliteral">"XC02_DISP_INITSTAT"</span>);
    }

    <span class="comment">/* auto brightness direction control */</span>
    <span class="keywordflow">if</span> ( (arg_brightdir == 0) || (arg_brightdir == 1 )) {
        printf(<span class="stringliteral">"- set auto brightness direction = %d\n"</span>, arg_brightdir );
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_AUTO_BRIGHT_CTRL, arg_brightdir)), <span class="stringliteral">"XC02_AUTO_BRIGHT_CTRL"</span>);
    }

    
    <span class="comment">/*-------------------------------+</span>
<span class="comment">     | handle shutdown event signal  |</span>
<span class="comment">     +-------------------------------*/</span>
    <span class="keywordflow">if</span>( sdEvtPollTime != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){

        <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html">M_SG_BLOCK</a>          blk;
        <a name="_a16"></a><a class="code" href="structXC02__BLK__DOWN__SIG.html">XC02_BLK_DOWN_SIG</a>   downSig;

        printf(<span class="stringliteral">"- handle shutdown event signal:\n"</span>);
        printf(<span class="stringliteral">"  The driver polls all %dms for an shutdown event\n"</span>,
               sdEvtPollTime);
        printf(<span class="stringliteral">"  and sends an signal to the App if the event-flag is set.\n"</span>);
        printf(<span class="stringliteral">"  The App sends OFF Acknowledge if the signal was received\n"</span>);

        <span class="comment">/* clear signal counters */</span>
        G_SigCountSdEvt = 0;
        G_SigCountOthers = 0;

        blk.<a name="a17"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o0">size</a>        = <span class="keyword">sizeof</span>(<a class="code" href="structXC02__BLK__DOWN__SIG.html">XC02_BLK_DOWN_SIG</a>);
        blk.<a name="a18"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/structM__SG__BLOCK.html#o1">data</a>        = (<span class="keywordtype">void</span>*)&amp;downSig;

        downSig.<a name="a19"></a><a class="code" href="structXC02__BLK__DOWN__SIG.html#o0">msec</a>    = sdEvtPollTime;
        downSig.<a name="a20"></a><a class="code" href="structXC02__BLK__DOWN__SIG.html#o1">signal</a>  = UOS_SIG_USR1;

        <span class="comment">/* install signal handler */</span>
        <span class="keywordflow">if</span>( UOS_SigInit(SigHandler) ){
            <a class="code" href="xc02__ctrl_8c.html#a9">PrintUosError</a>(<span class="stringliteral">"SigInit"</span>);
            <span class="keywordflow">return</span>(1);
        }

        <span class="comment">/* install signal */</span>
        <span class="keywordflow">if</span>( UOS_SigInstall(UOS_SIG_USR1) ){
            <a class="code" href="xc02__ctrl_8c.html#a9">PrintUosError</a>(<span class="stringliteral">"SigInstall"</span>);
            <span class="keywordflow">goto</span> abort;
        }

        <span class="comment">/* install signal for shutdown event */</span>
        <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_BLK_DOWN_SIG_SET,(INT32_OR_64)&amp;blk)),
            <span class="stringliteral">"XC02_BLK_DOWN_SIG_SET"</span>);
        printf(<span class="stringliteral">"--- press any key to abort ---\n"</span>);
    }

    <span class="comment">/*--------------------------+</span>
<span class="comment">     | input/temp/volt states   |</span>
<span class="comment">     |      AND / OR            |</span>
<span class="comment">     | wait event signal        |</span>
<span class="comment">     +--------------------------*/</span>
    <span class="keywordflow">if</span>( ( ioInfo != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ) || (sdEvtPollTime != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a>) ){
        printf(<span class="stringliteral">"--- To stop poll, press any key to abort ---\n"</span>);
        <span class="comment">/* repeat until keypress */</span>
        <span class="keywordflow">do</span> {
            <span class="keywordflow">if</span>( ioInfo != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
                <span class="keywordflow">if</span>( <a class="code" href="xc02__ctrl_8c.html#a10">ShowIo</a>() )
                    <span class="keywordflow">goto</span> abort;
            }
            <span class="keywordflow">if</span>( sdEvtPollTime != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
                <span class="keywordflow">if</span>( G_SigCountSdEvt ){
                    printf(<span class="stringliteral">"--- OFF Acknowledge sent ---\n"</span>);
                    printf(<span class="stringliteral">"--- system poweroff after off delay time ---\n"</span>);
                    <span class="keywordflow">goto</span> abort;
                }
            }
            UOS_Delay(1000);
        } <span class="keywordflow">while</span>( (UOS_KeyPressed() == -1) );
    }

    <span class="comment">/*--------------------+</span>
<span class="comment">      |  cleanup            |</span>
<span class="comment">      +--------------------*/</span>
abort:

    <span class="keywordflow">if</span>( sdEvtPollTime != <a class="code" href="xc02__ctrl_8c.html#a0">NONE</a> ){
        <span class="comment">/* terminate signal handling */</span>
        <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_DOWN_SIG_CLR, 0);
        UOS_SigExit();
        printf(<span class="stringliteral">"\n"</span>);
        printf(<span class="stringliteral">"Count of shutdown event signals : %d \n"</span>, G_SigCountSdEvt);
        printf(<span class="stringliteral">"Count of other signals          : %d \n"</span>, G_SigCountOthers);
    }

    <span class="keywordflow">if</span>( <a name="a21"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a9">M_close</a>(G_Path) &lt; 0 )
        <a class="code" href="xc02__ctrl_8c.html#a8">PrintMdisError</a>(<span class="stringliteral">"close"</span>);

    <span class="keywordflow">return</span>(0);
}

<span class="comment">/********************************* PrintMdisError **************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="xc02__ctrl_8c.html#a8">PrintMdisError</a>(<span class="keywordtype">char</span> *info)
{
    printf(<span class="stringliteral">"*** can't %s: %s\n"</span>, info, <a name="a22"></a><a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/m__errstr_8c.html#a0">M_errstring</a>(UOS_ErrnoGet()));
}


<span class="comment">/********************************* PrintUosError ***************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="xc02__ctrl_8c.html#a9">PrintUosError</a>(<span class="keywordtype">char</span> *info)
{
    printf(<span class="stringliteral">"*** can't %s: %s\n"</span>, info, UOS_ErrString(UOS_ErrnoGet()));
}


<span class="comment">/********************************* ShowIo **********************************/</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xc02__ctrl_8c.html#a10">ShowIo</a>( <span class="keywordtype">void</span> )
{
    int32 val;

    printf(<span class="stringliteral">" -------- binary i/o, temp and volt states: -------\n"</span>);

    <span class="comment">/* binary inputs state , val contains raw value */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_IN, &amp;val)),<span class="stringliteral">" XC02_IN"</span>);
    printf(<span class="stringliteral">"- binary inputs: KEY_IN = %d  GA[3:0] = 0x%x\n"</span>,
           val &amp; 0x1, (val&gt;&gt;1) &amp; 0xf);
    <span class="comment">/* temp */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP, &amp;val)),   <span class="stringliteral">" XC02_TEMP"</span>);
    printf(<span class="stringliteral">"- temperature :                        %d degree celsius (raw 0x%x)\n"</span>,
           <a class="code" href="xc02__drv_8h.html#a39">XC02_ADC2TEMP</a>(val), val);

    <span class="comment">/* voltage */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_VOLTAGE, &amp;val)),<span class="stringliteral">" XC02_VOLTAGE"</span>);
    printf(<span class="stringliteral">"- Voltage:                             %d mV  (raw 0x%x)\n"</span>,
           <a class="code" href="xc02__drv_8h.html#a41">XC02_ADC2VOLT</a>(val), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_DOWN_EVT, &amp;val)), <span class="stringliteral">"XC02_DOWN_EVT"</span>);
    printf(<span class="stringliteral">"- shutdown event flag:                 %d\n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_SW_DISP,  &amp;val )), <span class="stringliteral">"XC02_SW_DISP"</span>);
    printf(<span class="stringliteral">"- display switch status:               %d\n"</span>, val);

    <span class="comment">/* brightness */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BRIGHTNESS, &amp;val)),<span class="stringliteral">" XC02_BRIGHTNESS"</span>);
    printf(<span class="stringliteral">"- Brightness screen1: %d % (raw 0x%02x) "</span>, 100-(val&gt;&gt;1), val);
    <span class="comment">/* brightness2 */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>( (<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_BRIGHTNESS2, &amp;val)), <span class="stringliteral">" XC02_BRIGHTNESS2"</span>);
    printf(                                      <span class="stringliteral">"screen2: %d % (raw 0x%x)\n"</span>, 100-(val&gt;&gt;1), val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_RAW_BRIGHTNESS, &amp;val)),<span class="stringliteral">" XC02_RAW_BRIGHTNESS"</span>);
    printf(<span class="stringliteral">"- Brightness Raw ADC value:            0x%02x \n"</span>, val);

    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_KEY_IN_CTRL, &amp;val)),<span class="stringliteral">" XC02_KEY_IN_CTRL"</span>);
    printf(<span class="stringliteral">"- KEY_IN control:                      0x%02x (%s)\n"</span>, val, val ? <span class="stringliteral">"always on"</span> : <span class="stringliteral">"KEY_IN"</span>);


    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, SC21_BL_CURRENT, &amp;val )), <span class="stringliteral">" SC21_BL_CURRENT"</span>);
    <span class="keywordflow">if</span> (val == 0xff) {
        <span class="comment">/* 0xff returned, no register implemented (XC02) */</span>
        printf(<span class="stringliteral">"- drawn power (12V rail):              &lt;unknown&gt;\n"</span>); 
    } <span class="keywordflow">else</span> {
        printf(<span class="stringliteral">"- drawn power (12V rail):              %d W\n"</span>, <a class="code" href="xc02__drv_8h.html#a42">SC21_ADC2POWER</a>(val));
    }

    <span class="comment">/* Temp Limits */</span>
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP_HIGH, &amp;val)),<span class="stringliteral">" TEMP_HIGH"</span>);
    printf(<span class="stringliteral">"- Temp limits: high %d ,"</span>, val);
    <a class="code" href="xc02__ctrl_8c.html#a3">CHK</a>((<a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a12">M_getstat</a>(G_Path, XC02_TEMP_LOW, &amp;val)),<span class="stringliteral">" TEMP_LOW"</span>);
    printf(                         <span class="stringliteral">" low          %d degree C  \n"</span>, val);

    <span class="keywordflow">return</span>(0);

abort:
    <span class="keywordflow">return</span>(1);
}

<span class="comment">/********************************* SigHandler *******************************/</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> __MAPILIB <a class="code" href="xc02__ctrl_8c.html#a11">SigHandler</a>(u_int32 sigCode)
{
    <span class="keywordflow">if</span>(  sigCode == UOS_SIG_USR1){
        <span class="comment">/* send OFF Acknowledge */</span>
        <a class="codeRef" doxygen="mdis_api.tag:../../../../../LIBSRC/MDIS_API/DOC/html/" href="../../../../../LIBSRC/MDIS_API/DOC/html/mdis__api_8c.html#a13">M_setstat</a>(G_Path, XC02_OFFACK, 0);
        G_SigCountSdEvt++;
    }
    <span class="keywordflow">else</span>
        G_SigCountOthers++;
}


</pre></div> 
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for XC2 (DC1 carrier board) board controller driver using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

